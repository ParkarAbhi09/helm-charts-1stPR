suite: Test with custom values
templates:
  - secret.yaml
  - service.yaml
  - statefulset.yaml
  - persistentVolumeClaim.yaml
  - persistentVolume.yaml
tests:
  - it: should create a Secret with the correct value
    set:
      ldap:
        storage:
          accountname: name
          accountkey: key
    template: secret.yaml
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - equal:
          path: data.azurestorageaccountname
          value: bmFtZQ==
      - equal:
          path: data.azurestorageaccountkey
          value: a2V5
  - it: should create a custom service of type loadbalancer with legacy loadbalancerIP field
    template: service.yaml
    set:
      service:
        IP: 128.129.0.12
    asserts:
    - hasDocuments:
        count: 1
    - isKind:
        of: Service
    - equal:
        path: metadata.name
        value: RELEASE-NAME-ldap
    - equal:
        path: spec.type
        value: LoadBalancer
    - equal:
        path: spec.ports[0].port
        value: 636
    - equal:
        path: spec.ports[0].targetPort
        value: 636
    - equal:
        path: spec.selector["app.kubernetes.io/name"]
        value: ldap
    - equal:
        path: spec.selector["app.kubernetes.io/instance"]
        value: RELEASE-NAME
    - equal:
        path: spec.loadBalancerIP
        value: 128.129.0.12
    - notExists:
        path: metadata.annotations
  - it: should create a custom service of type loadbalancer with modern AKS annotation for public IP
    template: service.yaml
    set:
      service:
        azurePip:
          name: myAKSPublicIP
          resourceGroup: myNetworkResourceGroup
    asserts:
    - hasDocuments:
        count: 1
    - isKind:
        of: Service
    - equal:
        path: metadata.name
        value: RELEASE-NAME-ldap
    - equal:
        path: spec.type
        value: LoadBalancer
    - notExists:
        path: spec.loadBalancerIP
    - equal:
        path: metadata.annotations["service.beta.kubernetes.io/azure-load-balancer-resource-group"]
        value: myNetworkResourceGroup
    - equal:
        path: metadata.annotations["service.beta.kubernetes.io/azure-pip-name"]
        value: myAKSPublicIP
  - it: should create a statefulset with custom settings
    template: statefulset.yaml
    set:
      persistence:
        customBackupClaimName: superBackup
        customDataClaimName: batData
    asserts:
    - hasDocuments:
        count: 1
    - isKind:
        of: StatefulSet
    - equal:
        path: spec.template.spec.volumes[0].name
        value: backup
    - equal:
        path: spec.template.spec.volumes[0].persistentVolumeClaim.claimName
        value: superBackup
    - equal:
        path: spec.template.spec.volumes[1].name
        value: data
    - equal:
        path: spec.template.spec.volumes[1].persistentVolumeClaim.claimName
        value: batData
  - it: should not create any PVs or PVCs when specifying custom claim names
    template: persistentVolumeClaim.yaml
    set:
      persistence:
        customBackupClaimName: superBackup
        customDataClaimName: batData
    asserts:
    - hasDocuments:
        count: 0
  - it: should not create any PV when specifying custom claim names
    template: persistentVolume.yaml
    set:
      persistence:
        customBackupClaimName: superBackup
        customDataClaimName: batData
    asserts:
    - hasDocuments:
        count: 0
